<!DOCTYPE html>
<html>
<head>
    <title>Move the Fire</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<script src="https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.css" rel="stylesheet" />
	-->
	<script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
	<link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
	
	<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
	
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
		#search {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            width: 300px;
        }
    </style>
</head>
<body>
	<div id="search">
        <input type="text" id="address-input" placeholder="Enter an address">
        <button id="search-button">Search</button>
    </div>
    <div id="map"></div>
	
	<div id="welcome-modal" style="
	 font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Ubuntu, 'Helvetica Neue', sans-serif;
	 position: fixed;
	 top: 0; left: 0; width: 100%; height: 100%;
	 background: rgba(0, 0, 0, 0.5);
	 display: flex; align-items: center; justify-content: center;
	 z-index: 1000;
	 visibility: hidden;
	 "
	>
   <div style="
    background: rgba(255, 255, 255, 0.9); /* slightly transparent */
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
    text-align: center;
    max-width: 300px;
    backdrop-filter: blur(6px); /* blur behind */
	"
   >
    <h2 style="margin-bottom: 10px;">Welcome!</h2>
    <p style="margin-bottom: 20px;">Move the basemap, the area burned by the Ribaute, Aude fire (source Copernicus <a href=https://forest-fire.emergency.copernicus.eu/applications/data-and-services>Burnt areas database</a>) will stay centered.</p>
    <button onclick="closeModal()" style="
      padding: 10px 20px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    ">Close</button>
  </div>
</div>

<script>
  window.addEventListener('load', function () {
    document.getElementById('welcome-modal').style.visibility = 'visible';
  });

  function closeModal() {
    document.getElementById('welcome-modal').style.visibility = 'hidden';
  }
</script>
	
	<script>
        // Initialize the map
const map = new maplibregl.Map({
    container: 'map',
    style: {
        version: 8,
        sources: {
            // Base OSM layer
            osm: {
                type: 'raster',
                tiles: [
                    'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
                ],
                tileSize: 256,
                attribution:
                    '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            },
            // OpenSeaMap overlay
            openseamap: {
                type: 'raster',
                tiles: [
                    'https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png'
                ],
                tileSize: 256,
                attribution:
                    '© <a href="https://www.openseamap.org/">OpenSeaMap</a> contributors'
            }
        },
        layers: [
            {
                id: 'osm-layer',
                type: 'raster',
                source: 'osm'
            },
            {
                id: 'openseamap-layer',
                type: 'raster',
                source: 'openseamap'
            }
        ]
    },
    center: [2.76288858, 43.04968014],
    zoom: 10
});

        });

        // Add navigation control
        map.addControl(new maplibregl.NavigationControl(), 'top-right');
		
		// Listen for clicks on the search button
        document.getElementById('search-button').addEventListener('click', function() {
            const address = document.getElementById('address-input').value;
            searchAddress(address);
        });
		
		// Listen for Enter key in the input field
        document.getElementById('address-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                const address = document.getElementById('address-input').value;
                searchAddress(address);
            }
        });

        // Function to search for an address using the BAN API
        function searchAddress(address) {
            const url = `https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(address)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.features && data.features.length > 0) {
                        const feature = data.features[0];
                        const [lng, lat] = feature.geometry.coordinates;
                        map.setCenter([lng, lat]);
                        map.setZoom(10);
                    } else {
                        alert('No results found for this address.');
                    }
                })
                .catch(error => {
                    console.error('Error while searching for the address:', error);
                });
        }

        // Variable to store original GeoJSON data
        let originalGeoJSONData;
		let originalGeoJSONData2;

        // Load the polygon GeoJSON
        fetch('https://raw.githubusercontent.com/jeremieprudhomme/Deplace-le-feu/refs/heads/main/FDF.geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                originalGeoJSONData = data;
                map.on('load', function() {
                    // Add GeoJSON source
                    map.addSource('polygon', {
                        'type': 'geojson',
                        'data': originalGeoJSONData
                    });

                    // Add fill layer for the polygon
                    map.addLayer({
                        'id': 'polygon-layer',
                        'type': 'fill',
                        'source': 'polygon',
                        'layout': {},
                        'paint': {
                            'fill-color': '#ff2323',
                            'fill-opacity': 0.2
                        }
                    });
					
					map.addLayer({
                        'id': 'polygon-outline',
                        'type': 'line',
                        'source': 'polygon',
                        'layout': {},
                        'paint': {
                            'line-color': '#FF0000', // Red
                            'line-width': 1 // Line thickness
                        }
                    });
                });
            })
            .catch(error => {
                console.error('Error loading the GeoJSON:', error);
            });

        // Function to move the polygon to the center of the map
        function movePolygonToCenter() {
            const center = map.getCenter();

			// Calculate the centroid of the polygon using Turf.js
            const centroid = turf.centroid(originalGeoJSONData);
			
			// Calculate the offset to center the polygon
            const offset = {
                lng: center.lng - centroid.geometry.coordinates[0],
                lat: center.lat - centroid.geometry.coordinates[1]
            };

            // Update the polygon coordinates
            const updatedGeoJSONData = JSON.parse(JSON.stringify(originalGeoJSONData));
            updatedGeoJSONData.features[0].geometry.coordinates[0][0].forEach(coord => {
                coord[0] += offset.lng;
                coord[1] += offset.lat;
            });

            // Update the data source
            map.getSource('polygon').setData(updatedGeoJSONData);
        }

        // Listen for map movements
        map.on('move', movePolygonToCenter);
    </script>
</body>
</html>
